<!doctype html>

<%
  // Asegurar que si userTheme no está definido o es 'default' se use fondo blanco
  let initialTheme = (typeof userTheme !== 'undefined' && userTheme && String(userTheme).trim() !== 'default') ? userTheme : '#ffffff';
%>
<html lang="es" data-theme="<%= initialTheme %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Galería</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=<%= Date.now() %>">

</head>
<body>
  <header>
    <div class="brand">
      <img src="/imagen/klay.png" alt="Klay" class="logo-img header-logo">
    </div>
    <div class="controls">
      <button id="playMusic">▶ Música</button>
      <div class="theme">
        <label>Color principal:</label>
        <input type="color" id="colorPicker" value="<%= initialTheme %>">
        <button class="preset" data-color="#666666">Oscuro</button>
        <button class="preset" data-color="#ffffff">Claro</button>
        <button class="preset" data-color="#5b59a6">Azul</button>
        <button class="preset" data-color="#4a6d6b">Verde</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-left:12px;">
          <div style="position:relative;">
            <input id="searchProfiles" type="search" placeholder="Buscar perfiles..." style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);width:220px;" />
            <div id="searchResults" style="position:absolute;left:0;top:36px;background:var(--card);border:1px solid var(--border);border-radius:8px;display:none;min-width:220px;max-height:320px;overflow:auto;z-index:9999;padding:6px;"></div>
          </div>
          <button id="profileBtn" class="no-shimmer" title="Perfil" style="border:0;background:transparent;padding:0;position:relative;overflow:visible;">
            <img id="userAvatar" class="header-avatar" src="/imagen/default-avatar.png" alt="Avatar" />
            <span id="avatarBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:#e11d48;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;min-width:18px;height:18px;line-height:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.18);">0</span>
          </button>
      </div>
    </div>
  </header>

  <nav class="tabs">
  <button class="tab active" data-category="" data-default="true">Galería <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="FOTOS" data-default="true">Fotos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="RECUERDOS" data-default="true">Recuerdos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="VIDEO" data-default="true">Videos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
    <button id="addCategoryTabBtn" class="tab" title="Agregar categoría">+</button>
    <div id="addCategoryContainer" style="display:inline-block; margin-left:8px;"></div>
  </nav>

  <main>
    <section class="upload">
      <h2>Subir media (foto o video)</h2>
      <form id="uploadForm">
        <input type="text" name="title" placeholder="Título" required>
  <textarea name="description" placeholder="Descripción" maxlength="100"></textarea>
  <div style="font-size:12px;color:var(--muted);">Máx. 100 caracteres</div>
        <label>Fecha de la foto</label>
        <input type="date" name="date_taken" required>
        <label>Categoría</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <select name="category" id="categorySelect" required>
            <option value="GALERIA">GALERIA</option>
            <option value="FOTOS">FOTOS</option>
            <option value="RECUERDOS">RECUERDOS</option>
            <option value="VIDEO">VIDEO</option>
          </select>
        </div>
  <input type="file" name="file" id="uploadFiles" accept="image/*,video/*" required multiple>
        <button type="submit">Subir</button>
      </form>
      <p class="hint">Nota: la música se reproduce cuando haces clic en “Música” por políticas de los navegadores.</p>
    </section>

    <section>
      <h2 id="listTitle">Todas las fotos</h2>
      <div id="gallery" class="grid"></div>
    </section>
  </main>

  <audio id="bgMusic" loop>
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <template id="cardTemplate">
    <div class="card">
      <!-- Imagen o video (solo uno visible) -->
      <img class="card-img" alt="" style="display:block;max-width:100%;border-radius:6px;" />
      <video class="card-video" controls style="display:none;max-width:100%;border-radius:6px;background:#000"></video>
      <div class="card-body">
        <h3 class="card-title"></h3>
        <p class="card-desc"></p>
        <p class="card-date"></p>
        <p class="card-cat"></p>
        <div class="card-actions">
          <button class="edit">Editar</button>
          <button class="delete">Eliminar</button>
        </div>
      </div>
    </div>
  </template>

  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>Editar foto</h3>
      <form id="editForm">
        <input type="text" name="title" required>
        <textarea name="description"></textarea>
        <label>Fecha</label>
        <input type="date" name="date_taken" required>
        <label>Categoría</label>
        <select name="category" required>
          <option value="GALERIA">GALERIA</option>
          <option value="FOTOS">FOTOS</option>
          <option value="RECUERDOS">RECUERDOS</option>
        </select>
        <div class="modal-actions">
          <button type="submit">Guardar</button>
          <button type="button" id="closeModal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View modal: lightbox para ver la imagen completa -->
  <div id="viewModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content view-modal-content">
      <button id="closeView" style="float:right;padding:6px 10px;border-radius:8px;">Cerrar</button>
      <!-- Navegación: anterior / siguiente -->
      <!-- Side minimal nav buttons -->
      <button id="prevSide" class="view-nav left" aria-label="Anterior">◀</button>
      <button id="nextSide" class="view-nav right" aria-label="Siguiente">▶</button>
      <!-- Para mostrar la media en grande: imagen o video -->
      <img id="viewImage" src="" alt="" style="display:none;margin:12px auto; max-width:92vw; max-height:78vh; border-radius:8px;" />
      <video id="viewVideo" controls style="display:none;margin:12px auto; max-width:92vw; max-height:78vh; border-radius:8px;background:#000;"></video>
      <h3 id="viewTitle" style="text-align:center;margin-top:8px;color:var(--muted);"></h3>
    </div>
  </div>

  <script>
    // Para pruebas locales usa el mismo origen; en deploy pon la URL de tu backend
    // Exponer en `window` evita redeclaraciones de `const` en app.js
    window.API_BASE = window.location.origin; // ej. http://localhost:8080
  </script>
  <!-- Verificar sesión usando el endpoint server-side y manejar logout -->
  <script>
    (async function() {
      try {
        const res = await fetch('/auth/me', { credentials: 'include' });
        if (!res.ok) {
          // Si no está autenticado, redirigir al login
          window.location.href = '/login';
          return;
        }
        // Si es correcto, opcionalmente podríamos leer datos del usuario:
        // const j = await res.json(); console.log('user', j.user);
      } catch (e) {
        console.warn('No se pudo comprobar sesión:', e);
        window.location.href = '/login';
        return;
      }

      // Handler para el botón de logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) { /* ignore errors */ }
          window.location.href = '/login';
        });
      }
      // Mostrar panel de perfil cuando se pulse el avatar
      const profileBtn = document.getElementById('profileBtn');
      if (profileBtn) {
        profileBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Abrir el panel (se gestiona en app.js)
          const ev = new CustomEvent('openProfilePanel');
          window.dispatchEvent(ev);
        });
      }
      // Buscador de perfiles
      const searchInput = document.getElementById('searchProfiles');
      const resultsBox = document.getElementById('searchResults');
      let searchTimer = null;
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimer);
          const q = (e.target.value || '').trim();
          if (!q) { resultsBox.style.display = 'none'; resultsBox.innerHTML = ''; return; }
          searchTimer = setTimeout(async () => {
            try {
              const r = await fetch(`/api/users?q=${encodeURIComponent(q)}`);
              if (!r.ok) { resultsBox.style.display='none'; return; }
              const data = await r.json();
              resultsBox.innerHTML = '';
              if (!Array.isArray(data) || data.length === 0) { resultsBox.innerHTML = '<div class="muted" style="padding:8px;">Sin resultados</div>'; resultsBox.style.display='block'; return; }
              data.slice(0,20).forEach(u => {
                const row = document.createElement('div');
                row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='6px'; row.style.cursor='pointer';
                row.addEventListener('click', ()=>{ window.location.href = '/u/' + encodeURIComponent(u.id); });
                const img = document.createElement('img'); img.src = u.avatar_url || '/imagen/default-avatar.png'; img.style.width='36px'; img.style.height='36px'; img.style.borderRadius='50%'; img.style.objectFit='cover';
                const txt = document.createElement('div'); txt.innerHTML = `<strong style="display:block">${u.full_name||u.email}</strong><span style="font-size:12px;color:var(--muted);">${u.profile_description ? (u.profile_description.substr(0,80)) : ''}</span>`;
                row.appendChild(img); row.appendChild(txt);
                resultsBox.appendChild(row);
              });
              resultsBox.style.display = 'block';
            } catch (err) { console.error('Search error', err); resultsBox.style.display='none'; }
          }, 300);
        });
        // cerrar al click fuera
        document.addEventListener('click', (ev)=>{ if (!resultsBox.contains(ev.target) && ev.target !== searchInput) { resultsBox.style.display='none'; } });
      }
    })();
  </script>

  <!-- Panel / Modal de Perfil (rellenado por app.js) -->
  <div id="profilePanel" class="profile-popover hidden" aria-hidden="true">
    <div class="profile-header">
      <img id="profileAvatarLarge" class="profile-avatar-large" src="/imagen/default-avatar.png" alt="Avatar" />
      <div>
        <div id="profileName" class="profile-name"></div>
        <div id="profileEmail" class="profile-email"></div>
      </div>
    </div>
    <hr style="margin:12px 0; border:none; border-top:1px solid var(--border);" />
    <h4 style="margin:0 0 6px 0;">Perfil</h4>
    <textarea id="profileDescription" rows="4" placeholder="Escribe algo sobre ti..."></textarea>
    
    <hr style="margin:12px 0; border:none; border-top:1px solid var(--border);" />
    <h4 style="margin:0 0 6px 0;">Bandeja de mensajes</h4>
    <div id="panelInbox" style="max-height:220px;overflow:auto;margin-bottom:6px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.03);">
      <div class="muted" id="panelInboxEmpty">Cargando mensajes...</div>
    </div>

    <!-- Area de chat dentro del panel: oculto por defecto, se muestra al abrir una conversación -->
    <div id="panelChat" style="display:none;margin-top:8px;border-radius:8px;padding:8px;background:rgba(0,0,0,0.02);max-height:280px;overflow:hidden;">
      <div id="panelChatHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div id="panelChatTitle" style="font-weight:700">Chat</div>
        <div style="display:flex;gap:6px"><button id="panelBackToInbox" class="btn" style="padding:4px 8px">← Bandeja</button><button id="panelCloseChat" class="btn" style="padding:4px 8px">Cerrar</button></div>
      </div>
      <div id="panelChatBody" style="height:160px;overflow:auto;padding:6px;border-radius:6px;background:rgba(0,0,0,0.03);margin-bottom:6px"></div>
      <div style="display:flex;gap:6px;align-items:center">
        <input id="panelChatInput" placeholder="Escribe un mensaje..." style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:inherit" />
        <button id="panelChatSend" class="btn btn-primary">Enviar</button>
      </div>
    </div>
    <div class="profile-actions">
      <button id="deleteProfileDesc" class="btn-logout">Eliminar</button>
      <button id="logoutInPanel" class="btn-logout">Cerrar sesión</button>
      <button id="saveProfileDesc" class="btn-save">Guardar</button>
    </div>
  </div>
  <script src="app.js"></script>
  <script src="music.js" defer></script>

  <!-- Chat drawer (fixed bottom) -->
  <div id="chatDrawer" style="position:fixed;right:16px;bottom:16px;width:360px;max-width:calc(100% - 32px);background:var(--bg);color:var(--text);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:none;flex-direction:column;overflow:hidden;z-index:9999">
    <div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between">
      <div id="chatTitle" style="font-weight:700">Chat</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatClose" class="btn">Cerrar</button>
      </div>
    </div>
    <div id="chatBody" style="padding:8px;max-height:320px;overflow:auto;background:transparent;display:flex;flex-direction:column;gap:8px"></div>
    <div style="padding:8px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center">
      <input id="chatInput" placeholder="Escribe un mensaje..." style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit" />
      <button id="chatSend" class="btn btn-primary">Enviar</button>
    </div>
  </div>

  <!-- Music manager modal -->
  <div id="musicModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:720px;">
      <h3>Gestor de música</h3>
      <form id="musicForm">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <input type="text" name="title" placeholder="Título" required style="flex:1;min-width:160px;" />
          <input type="text" name="artist" placeholder="Artista" required style="flex:1;min-width:160px;" />
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
          <input type="file" name="file" accept="audio/*" required />
          <button type="submit">Guardar</button>
          <button type="button" id="closeMusic">Cancelar</button>
        </div>
      </form>

      <h4 style="margin-top:18px;">Tus pistas</h4>
      <div id="musicList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner">
      <div class="footer-brand">
        <img src="/imagen/klay.png" alt="Klay-Up" class="footer-logo">
        <div class="footer-title">Klay-Up</div>
      </div>
      <div class="footer-links">
        <a href="mailto:contacto@klay-up.local" class="footer-link">Contacto</a>
        <a href="#" class="footer-link">Privacidad</a>
        <a href="#" class="footer-link">EL mismo elefanto</a>
      </div>
      <div class="footer-copy">© <span id="footerYear"></span> Klay-Up</div>
    </div>
  </footer>

  <script>
    // footer year dinámico
    try { document.getElementById('footerYear').textContent = new Date().getFullYear(); } catch(e){}
  </script>
</body>
</html>
