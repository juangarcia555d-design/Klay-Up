<!doctype html>

<%
  // Asegurar que si userTheme no está definido o es 'default' se use fondo blanco
  let initialTheme = (typeof userTheme !== 'undefined' && userTheme && String(userTheme).trim() !== 'default') ? userTheme : '#ffffff';
%>
<html lang="es" data-theme="<%= initialTheme %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Galería</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=<%= Date.now() %>">

</head>
<body>
  <header>
    <div class="brand">
      <img src="/imagen/klay.png" alt="Klay" class="logo-img header-logo">
    </div>
    <div class="controls">
      <button id="playMusic">▶ Música</button>
      <div class="theme">
        <!-- COLORES DE LOS TEMAS  -->
        <label>Color principal:</label>
        <input type="color" id="colorPicker" value="<%= initialTheme %>">
        <button class="preset" data-color="#141414">Oscuro</button>
        <button class="preset" data-color="#ffffff">Claro</button>
        <button class="preset" data-color="#5b59a6">Azul</button>
        <button class="preset" data-color="#4a6d6b">Verde</button>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-left:12px;">
          <div style="position:relative;">
            <input id="searchProfiles" type="search" placeholder="Buscar perfiles..." style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);width:220px;" />
            <div id="searchResults" style="position:absolute;left:0;top:36px;background:var(--card);border:1px solid var(--border);border-radius:8px;display:none;min-width:220px;max-height:320px;overflow:auto;z-index:9999;padding:6px;"></div>
          </div>
          <button id="profileBtn" class="no-shimmer" title="Perfil" style="border:0;background:transparent;padding:0;position:relative;overflow:visible;">
            <img id="userAvatar" class="header-avatar" src="/imagen/default-avatar.png" alt="Avatar" />
            <span id="avatarBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:#e11d48;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;min-width:18px;height:18px;line-height:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.18);">0</span>
          </button>
          <button id="invitationsBtn" title="Notificaciones" style="border:0;background:transparent;padding:6px;margin-left:8px;position:relative;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;opacity:0.9"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6V11c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 10-3 0v.68C7.63 5.36 6 7.92 6 11v5l-1.99 2c-.01.01-.01.02-.01.03 0 .55.45 1 1 1h16c.55 0 1-.45 1-1 0-.01 0-.02-.01-.03L18 16z" fill="currentColor"/></svg>
            <span id="notificationsBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:#e11d48;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;min-width:18px;height:18px;line-height:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.18);">0</span>
          </button>
      </div>
    </div>
  </header>

  <nav class="tabs">
  <button class="tab active" data-category="" data-default="true">Galería <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="FOTOS" data-default="true">Fotos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="RECUERDOS" data-default="true">Recuerdos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
  <button class="tab" data-category="VIDEO" data-default="true">Videos <span class="tab-delete" title="Eliminar categoría">✕</span></button>
    <button id="addCategoryTabBtn" class="tab" title="Agregar categoría">+</button>
    <div id="addCategoryContainer" style="display:inline-block; margin-left:8px;"></div>
  </nav>

  <main>
    <section class="upload">
      <h2>Subir media (foto o video)</h2>
      <form id="uploadForm" class="upload-grid" novalidate>
        <div class="upload-left">
          <label class="field">Título <input type="text" name="title" placeholder="Título" required></label>
          <label class="field">Descripción <textarea name="description" placeholder="Descripción" maxlength="250"></textarea></label>
          <div class="row">
            <label class="field small">Categoría
              <select name="category" id="categorySelect" required>
                <option value="GALERIA">GALERIA</option>
                <option value="FOTOS">FOTOS</option>
                <option value="RECUERDOS">RECUERDOS</option>
                <option value="VIDEO">VIDEO</option>
              </select>
            </label>
          </div>
        </div>

        <div class="upload-right">
          <div id="dropArea" class="drop-area">
            <input type="file" name="file" id="uploadFiles" accept="image/*,video/*" multiple hidden>
            <div class="drop-content">
              <strong>Arrastra y suelta tus archivos aquí</strong>
              <span class="muted">o</span>
              <button type="button" id="selectFilesBtn" class="btn secondary">Seleccionar archivos</button>
              <p class="muted small">Soporta imágenes y videos. Puedes subir varios.</p>
            </div>
          </div>

          <div id="uploadPreview" class="upload-preview" aria-live="polite"></div>

          <div id="uploadProgressWrap" class="upload-progress-wrap hidden">
            <div class="progress-info"><span id="progressLabel">Preparando...</span><span id="progressPercent">0%</span></div>
            <div class="progress-bar-outer"><div id="uploadProgressBar" class="progress-bar-inner"></div></div>
          </div>

          <div class="upload-actions">
            <button type="submit" class="btn primary">Subir</button>
            <button type="button" id="clearFilesBtn" class="btn ghost">Limpiar</button>
          </div>
        </div>
      </form>
      <p class="hint">Nota: la música se reproduce cuando haces clic en “Música” por políticas de los navegadores.</p>
    </section>

    <section>
      <h2 id="listTitle">Todas las fotos</h2>
      <div id="gallery" class="grid"></div>
      <div id="galleryEndSentinel" style="height:1px;width:100%;"></div>
    </section>
  </main>

  <audio id="bgMusic" loop>
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <template id="cardTemplate">
    <div class="card">
      <!-- Imagen o video (solo uno visible) -->
      <img class="card-img" alt="" style="display:block;max-width:100%;border-radius:6px;" />
      <video class="card-video" controls style="display:none;max-width:100%;border-radius:6px;background:#000"></video>
      <div class="card-body">
        <h3 class="card-title"></h3>
        <p class="card-desc"></p>
        <p class="card-date"></p>
        <p class="card-cat"></p>
        <div class="card-actions">
          <button class="card-ellipsis no-shimmer" type="button" title="Más acciones">⋯</button>
          <div class="card-ellipsis-menu hidden">
            <button class="menu-item card-edit" type="button">Editar</button>
            <button class="menu-item card-delete" type="button">Eliminar</button>
          </div>
        </div>
        <!-- Comentarios: lista y pequeño formulario -->
        <div class="card-comments" style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;">
          <div class="comments-list" style="max-height:160px;overflow:auto;margin-bottom:8px;padding-right:6px;"></div>
          <form class="comment-form" style="display:flex;gap:8px;align-items:flex-start;">
            <img class="comment-avatar" src="/imagen/default-avatar.png" alt="avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;display:none;" />
            <textarea name="comment" placeholder="Añade un comentario..." rows="1" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);resize:vertical;min-height:38px;"></textarea>
            <button type="submit" class="btn small primary" style="white-space:nowrap;">Comentar</button>
          </form>
        </div>
      </div>
    </div>
  </template>

      <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <h3>Editar foto</h3>
      <form id="editForm">
        <input type="text" name="title" required>
        <textarea name="description"></textarea>
        <!-- Fecha eliminada: se usará la hora de publicación automática -->
        <label>Categoría</label>
        <select name="category" required>
          <option value="GALERIA">GALERIA</option>
          <option value="FOTOS">FOTOS</option>
          <option value="RECUERDOS">RECUERDOS</option>
        </select>
        <div class="modal-actions">
          <button type="submit">Guardar</button>
          <button type="button" id="closeModal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View modal: lightbox para ver la imagen completa -->
  <div id="viewModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content view-modal-content">
      <button id="closeView" style="float:right;padding:6px 10px;border-radius:8px;">Cerrar</button>
      <!-- Navegación: anterior / siguiente -->
      <!-- Side minimal nav buttons -->
      <button id="prevSide" class="view-nav left" aria-label="Anterior">◀</button>
      <button id="nextSide" class="view-nav right" aria-label="Siguiente">▶</button>
      <!-- Para mostrar la media en grande: imagen o video -->
      <img id="viewImage" src="" alt="" style="display:none;margin:12px auto; max-width:92vw; max-height:78vh; border-radius:8px;" />
      <video id="viewVideo" controls style="display:none;margin:12px auto; max-width:92vw; max-height:78vh; border-radius:8px;background:#000;"></video>
      <h3 id="viewTitle" style="text-align:center;margin-top:8px;color:var(--muted);"></h3>
    </div>
  </div>

  <script>
    // Para pruebas locales usa el mismo origen; en deploy pon la URL de tu backend
    // Exponer en `window` evita redeclaraciones de `const` en app.js
    window.API_BASE = window.location.origin; // ej. http://localhost:8080
  </script>
  <!-- Verificar sesión usando el endpoint server-side y manejar logout -->
  <script>
    (async function() {
      try {
        const res = await fetch('/auth/me', { credentials: 'include' });
        if (!res.ok) {
          // Si no está autenticado, redirigir al login
          window.location.href = '/login';
          return;
        }
        // Si es correcto, opcionalmente podríamos leer datos del usuario:
        // const j = await res.json(); console.log('user', j.user);
      } catch (e) {
        console.warn('No se pudo comprobar sesión:', e);
        window.location.href = '/login';
        return;
      }

      // Handler para el botón de logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
          } catch (err) { /* ignore errors */ }
          window.location.href = '/login';
        });
      }
      // Mostrar panel de perfil cuando se pulse el avatar
      const profileBtn = document.getElementById('profileBtn');
      if (profileBtn) {
        profileBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Abrir el panel (se gestiona en app.js)
          const ev = new CustomEvent('openProfilePanel');
          window.dispatchEvent(ev);
        });
      }
      // Buscador de perfiles
      const searchInput = document.getElementById('searchProfiles');
      const resultsBox = document.getElementById('searchResults');
      let searchTimer = null;
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimer);
          const q = (e.target.value || '').trim();
          if (!q) { resultsBox.style.display = 'none'; resultsBox.innerHTML = ''; return; }
          searchTimer = setTimeout(async () => {
            try {
              const r = await fetch(`/api/users?q=${encodeURIComponent(q)}`);
              if (!r.ok) { resultsBox.style.display='none'; return; }
              const data = await r.json();
              resultsBox.innerHTML = '';
              if (!Array.isArray(data) || data.length === 0) { resultsBox.innerHTML = '<div class="muted" style="padding:8px;">Sin resultados</div>'; resultsBox.style.display='block'; return; }
              data.slice(0,20).forEach(u => {
                const row = document.createElement('div');
                row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.style.padding='6px'; row.style.cursor='pointer';
                row.addEventListener('click', ()=>{ window.location.href = '/u/' + encodeURIComponent(u.id); });
                const img = document.createElement('img'); img.src = u.avatar_url || '/imagen/default-avatar.png'; img.style.width='36px'; img.style.height='36px'; img.style.borderRadius='50%'; img.style.objectFit='cover';
                const badgeHtml = u.verified_role ? (String(u.verified_role).toUpperCase() === 'ADMIN' ? '<span class="verified-badge admin" title="Administrador verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M9.5 16.5L5 12l1.4-1.4L9.5 13.7 17.6 5.6 19 7l-9.5 9.5z"></path></svg></span>' : '<span class="verified-badge artist" title="Artista verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M12 2C7.03 2 3 6.03 3 11c0 2.95 2.41 5.4 5.36 5.7.66.07 1.2.61 1.3 1.27.16 1.09 1.15 1.93 2.26 1.93 4.97 0 9-4.03 9-9S16.97 2 12 2zm-1 5a1 1 0 11.001 2.001A1 1 0 0111 7zm4 2a1 1 0 11.001 2.001A1 1 0 0115 9z"></path></svg></span>' ) : '';
                const txt = document.createElement('div'); txt.innerHTML = `<strong style="display:block">${u.full_name||u.email}</strong>${badgeHtml}<span style="font-size:12px;color:var(--muted);">${u.profile_description ? (u.profile_description.substr(0,80)) : ''}</span>`;
                row.appendChild(img); row.appendChild(txt);
                resultsBox.appendChild(row);
              });
              resultsBox.style.display = 'block';
            } catch (err) { console.error('Search error', err); resultsBox.style.display='none'; }
          }, 300);
        });
        // cerrar al click fuera
        document.addEventListener('click', (ev)=>{ if (!resultsBox.contains(ev.target) && ev.target !== searchInput) { resultsBox.style.display='none'; } });
      }
    })();
  </script>

  <!-- Panel / Modal de Perfil (rellenado por app.js) -->
  <div id="profilePanel" class="profile-popover hidden" aria-hidden="true">
    <div class="profile-panel-inner">
      <div class="profile-top">
        <div class="profile-avatar-wrap">
          <img id="profileAvatarLarge" class="profile-avatar-large" src="/imagen/default-avatar.png" alt="Avatar" />
        </div>
        <div class="profile-meta">
          <div id="profileName" class="profile-name">Usuario</div>
          <div id="profileEmail" class="profile-email muted">correo@ejemplo.com</div>
          <div class="profile-stats">
            <div class="stat"><span id="followerCount">0</span><small> seguidores</small></div>
            <div class="stat"><span id="followingCount">0</span><small> siguiendo</small></div>
          </div>
        </div>
      </div>

      <div class="profile-body">
        <label class="label">Sobre mí</label>
        <textarea id="profileDescription" rows="4" placeholder="Escribe algo sobre ti..."></textarea>
        <div id="panelInboxBubbles" class="panel-bubbles"></div>

        <!-- Controles de edición eliminados: ahora el guardado es automático -->
      </div>

      <!-- Acciones separadas por finalidad: cuenta vs chat -->
      <div class="profile-footer">
        <div class="account-actions">
          <button id="logoutInPanel" class="btn ghost small">Cerrar sesión</button>
        </div>
        <div class="chat-actions">
          <button id="createGroupChatBtn" class="btn primary">Crear chat grupal</button>
        </div>
      </div>
      <div id="panelChat" class="panel-chat hidden">
        <div class="panel-chat-header"><div id="panelChatTitle">Chat</div><div><button id="panelBackToInbox" class="btn">← Bandeja</button><button id="panelCloseChat" class="btn">Cerrar</button></div></div>
        <div id="panelChatBody" class="panel-chat-body"></div>
        <div class="panel-chat-compose"><input id="panelChatInput" placeholder="Escribe un mensaje..." /><button id="panelChatSend" class="btn btn-primary">Enviar</button></div>
      </div>
    </div>
  </div>

  <!-- Modal: crear chat grupal -->
  <div id="groupChatModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:720px;">
      <button id="closeGroupChatModal" style="float:right;padding:6px 10px;border-radius:8px;">Cerrar</button>
      <h3>Crear chat grupal</h3>
      <p>Selecciona las personas (seguidores/seguidos) que quieres invitar:</p>
      <div style="display:flex;gap:12px;">
        <div style="flex:1;max-height:320px;overflow:auto;border:1px solid var(--border);padding:8px;border-radius:8px;">
          <div style="font-weight:700;margin-bottom:8px;">Contactos</div>
          <div id="groupContactsList"></div>
        </div>
        <div style="width:260px;">
          <label>Título (opcional)</label>
          <input id="groupTitleInput" placeholder="Nombre del grupo" style="width:100%;padding:8px;margin-bottom:8px;border-radius:6px;border:1px solid var(--border)" />
          <button id="sendGroupInvitesBtn" class="btn primary" style="width:100%;">Enviar invitaciones</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: notificaciones -->
  <div id="notificationsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:720px;">
      <button id="closeNotificationsModal" style="float:right;padding:6px 10px;border-radius:8px;">Cerrar</button>
      <h3>Notificaciones</h3>
      <div id="notificationsList" style="max-height:420px;overflow:auto;padding-top:8px"></div>
    </div>
  </div>
  <script src="/app.js?v=<%= Date.now() %>"></script>
  <script src="music.js" defer></script>

  <!-- Chat drawer (fixed bottom) -->
  <div id="chatDrawer" style="position:fixed;right:16px;bottom:16px;width:360px;max-width:calc(100% - 32px);background:var(--bg);color:var(--text);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:none;flex-direction:column;overflow:hidden;z-index:9999">
    <div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between">
      <div id="chatTitle" style="font-weight:700">Chat</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatClose" class="btn">Cerrar</button>
      </div>
    </div>
    <div id="chatBody" style="padding:8px;max-height:320px;overflow:auto;background:transparent;display:flex;flex-direction:column;gap:8px"></div>
    <div style="padding:8px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center">
      <input id="chatInput" placeholder="Escribe un mensaje..." style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit" />
      <button id="chatSend" class="btn btn-primary">Enviar</button>
    </div>
  </div>

  <!-- Floating side bubbles for incoming chats (created dynamically by app.js) -->
  <div id="sideChatBubbles" style="position:fixed;right:12px;top:40%;display:flex;flex-direction:column;gap:10px;z-index:99999;pointer-events:auto"></div>

  <!-- Music manager modal -->
  <div id="musicModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content" style="max-width:720px;">
      <h3>Gestor de música</h3>
      <form id="musicForm">
        <div class="music-form-row">
          <input class="music-input" type="text" name="title" placeholder="Título" required />
          <input class="music-input" type="text" name="artist" placeholder="Artista" required />
        </div>
        <div class="music-form-row music-form-actions">
          <label class="file-label">Seleccionar archivo<input class="music-file" type="file" name="file" accept="audio/*" required /></label>
          <div style="display:flex;gap:8px;align-items:center">
            <button type="submit" class="btn primary">Guardar</button>
            <button type="button" id="closeMusic" class="btn ghost">Cancelar</button>
          </div>
        </div>
      </form>

      <h4 style="margin-top:18px;">Tus pistas</h4>
      <div id="musicList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner">
      <div class="footer-brand">
        <img src="/imagen/klay.png" alt="Klay-Up" class="footer-logo">
        <div class="footer-title">Klay-Up</div>
      </div>
      <div class="footer-links">
        <a href="mailto:contacto@klay-up.local" class="footer-link">Contacto</a>
        <a href="#" class="footer-link">Privacidad</a>
        <a href="#" class="footer-link">EL mismo elefanto</a>
      </div>
      <div class="footer-copy">© <span id="footerYear"></span> Klay-Up</div>
    </div>
  </footer>

  <script>
    // footer year dinámico
    try { document.getElementById('footerYear').textContent = new Date().getFullYear(); } catch(e){}
  </script>
</body>
</html>
