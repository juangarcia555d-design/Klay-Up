<!doctype html>
<%
  const initialTheme = (user && user.theme && String(user.theme).trim() !== 'default') ? user.theme : '#ffffff';
%>
<html lang="es" data-theme="<%= initialTheme %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mi Perfil — Klay-Up</title>
  <link rel="stylesheet" href="/styles.css?v=<%= Date.now() %>">
  <link rel="stylesheet" href="/profile.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <main style="max-width:920px;margin:32px auto;padding:16px;">
    <a href="/app" style="display:inline-block;margin-bottom:12px;">← Volver</a>
    <section class="profile-full">
      <div class="profile-hero">
        <img id="profileFullAvatar" src="<%= user.avatar_url || '/imagen/default-avatar.png' %>" alt="Avatar" class="profile-avatar-large" />
        <div class="profile-meta">
          <h1><%= user.full_name || 'Sin nombre' %></h1>
          <div class="muted"><%= user.email %></div>
          <p class="profile-desc"><%= user.profile_description || '' %></p>
          <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
            <div style="font-weight:600;cursor:pointer;" id="followerCount">Seguidores: <span id="followerNum"><%= typeof followerCount !== 'undefined' ? followerCount : 0 %></span></div>
            <div style="font-weight:600;cursor:pointer;" id="followingCount">Siguiendo: <span id="followingNum"><%= typeof followingCount !== 'undefined' ? followingCount : 0 %></span></div>
          </div>
          <div class="profile-actions">
            <% if (typeof isOwner !== 'undefined' && isOwner) { %>
              <a class="btn btn-primary" href="/app">Mi panel</a>
            <% } %>
            <% if (!isOwner && viewerAuthenticated) { %>
              <button id="followBtn" class="btn btn-primary"><%= (typeof isFollowing !== 'undefined' && isFollowing) ? 'Siguiendo' : 'Seguir' %></button>
              <button id="msgBtn" class="btn">Mensaje</button>
            <% } %>
            <a class="btn" href="/u/<%= user.id %>">Compartir</a>
          </div>
        </div>
      </div>

      <hr />

      <% if (typeof isOwner !== 'undefined' && isOwner) { %>
      <section class="profile-upload">
        <h3>Subir fotos a tu galería</h3>
        <form id="profileUploadForm" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="Título" />
            <textarea name="description" placeholder="Descripción (máx 100 chars)" maxlength="100"></textarea>
          <input type="date" name="date_taken" />
          <select name="category">
            <option value="GALERIA">GALERIA</option>
            <option value="FOTOS">FOTOS</option>
            <option value="RECUERDOS">RECUERDOS</option>
          </select>
          <input type="file" name="file" accept="image/*,video/*" multiple required />
          <div style="margin-top:8px;"><button type="submit">Subir a mi galería</button></div>
        </form>
      </section>
      <% } %>

      <section style="margin-top:18px;">
      <% /* Bandeja movida al panel (avatar) - se muestra en el panel de avatar en index */ %>
        <h3>Mis fotos</h3>
        <div id="myPhotos" class="grid">
          <% if (Array.isArray(photos) && photos.length) { %>
            <% photos.forEach(function(it) { %>
              <div class="card">
                <% if (it.url && (it.url.toLowerCase().endsWith('.mp4') || it.url.toLowerCase().endsWith('.webm') || it.url.toLowerCase().endsWith('.ogg') || it.url.toLowerCase().endsWith('.mov') || it.url.toLowerCase().endsWith('.m4v'))) { %>
                  <video class="card-video" controls style="max-width:100%;border-radius:6px;background:#000"><source src="<%= it.url %>" /></video>
                <% } else { %>
                  <img class="card-img" src="<%= it.url %>" alt="<%= it.title || 'Foto' %>" style="max-width:100%;border-radius:6px;" />
                <% } %>
                <div class="card-body">
                  <h3 class="card-title"><%= it.title || '' %></h3>
                  <p class="card-desc"><%= it.description || '' %></p>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="muted">No hay fotos en tu galería todavía.</div>
          <% } %>
        </div>
      </section>
    </section>
  </main>

  <!-- Chat drawer (fixed bottom) -->
  <div id="chatDrawer" style="position:fixed;right:16px;bottom:16px;width:360px;max-width:calc(100% - 32px);background:var(--bg);color:var(--text);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:none;flex-direction:column;overflow:hidden;z-index:9999">
    <div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between">
      <div id="chatTitle" style="font-weight:700">Chat</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatClose" class="btn">Cerrar</button>
      </div>
    </div>

    <!-- Avatar picker modal -->
    <div id="avatarPickerModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:100000"> 
      <div style="max-width:680px;width:94%;background:var(--bg);color:var(--text);padding:12px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.25);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Seleccionar avatar</strong>
          <button id="closeAvatarPicker" class="btn">Cerrar</button>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;max-height:48vh;overflow:auto;padding:6px" id="avatarList">Loading avatars...</div>
        <hr style="margin:10px 0" />
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-weight:600">Subir avatar</label>
          <input id="avatarFile" type="file" accept="image/*" />
          <button id="avatarUploadBtn" class="btn btn-primary">Subir</button>
          <div id="avatarUploadProgress" style="flex:1;display:none;margin-left:8px;height:8px;background:rgba(0,0,0,0.06);border-radius:8px;overflow:hidden"><div style="height:100%;width:0%;background:linear-gradient(90deg,#6b46c1,#7c3aed);transition:width 120ms linear"></div></div>
        </div>
      </div>
    </div>
    <div id="chatBody" style="padding:8px;max-height:320px;overflow:auto;background:transparent;display:flex;flex-direction:column;gap:8px"></div>
    <div style="padding:8px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center">
      <input id="chatInput" placeholder="Escribe un mensaje..." style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit" />
      <button id="chatSend" class="btn btn-primary">Enviar</button>
    </div>
  </div>

  <script>
    window.SUPABASE_URL = "<%= SUPABASE_URL %>" || '';
    window.SUPABASE_ANON_KEY = "<%= SUPABASE_ANON_KEY %>" || '';
    window.API_BASE = window.location.origin;
  </script>
  <script>
    (function(){
      const followBtn = document.getElementById('followBtn');
      const profileUserId = '<%= user.id %>';
      if (followBtn) {
        followBtn.addEventListener('click', async () => {
          try {
            const current = followBtn.textContent.trim();
            let action = 'follow';
            if (current === 'Siguiendo' || current.toLowerCase() === 'siguiendo') action = 'unfollow';

            const endpoint = `/api/users/${profileUserId}/${action}`;
            const res = await fetch(endpoint, { method: 'POST', credentials: 'include' });
            if (!res.ok) {
              const j = await res.json().catch(()=>null);
              alert((j && j.error) ? j.error : 'Error');
              return;
            }

            const data = await res.json();
            // actualizar contadores si vienen
            if (typeof data.followerCount !== 'undefined') document.getElementById('followerNum').textContent = data.followerCount || 0;
            if (typeof data.followingCount !== 'undefined') document.getElementById('followingNum').textContent = data.followingCount || 0;

            // actualizar etiqueta
            if (action === 'follow') followBtn.textContent = 'Siguiendo';
            else followBtn.textContent = 'Seguir';
          } catch (e) { console.error(e); alert('Error al realizar la acción'); }
        });
      }

      const followerCountEl = document.getElementById('followerCount');
      if (followerCountEl) {
        followerCountEl.addEventListener('click', async () => {
          try {
            const res = await fetch(`/api/users/${profileUserId}/followers`);
            if (!res.ok) {
              const j = await res.json().catch(()=>null); alert((j&&j.error)?j.error:'Error'); return;
            }
            const j = await res.json();
            const list = (j.data || []).map(item => {
              const u = item.user || item || {};
              return `<div style="display:flex;align-items:center;gap:8px;padding:8px"><img src="${u.avatar_url||'/imagen/default-avatar.png'}" style="width:32px;height:32px;border-radius:999px;object-fit:cover"/><div>${u.full_name||u.email||u.id}</div></div>`;
            }).join('');
            const modal = document.createElement('div');
            modal.style.position = 'fixed'; modal.style.left='0'; modal.style.top='0'; modal.style.right='0'; modal.style.bottom='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center';
            modal.innerHTML = `<div style="max-width:420px;width:90%;background:var(--bg);color:var(--text);padding:12px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2)"><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'><strong>Seguidores</strong><button id='closeModal'>Cerrar</button></div><div style='max-height:60vh;overflow:auto'>${list || '<div class="muted">No tiene seguidores</div>'}</div></div>`;
            document.body.appendChild(modal);
            modal.querySelector('#closeModal').addEventListener('click', ()=>modal.remove());
          } catch (e) { console.error(e); alert('Error al obtener seguidores'); }
        });
      }

      const followingCountEl = document.getElementById('followingCount');
      if (followingCountEl) {
        followingCountEl.addEventListener('click', async () => {
          try {
            const res = await fetch(`/api/users/${profileUserId}/following`);
            if (!res.ok) {
              const j = await res.json().catch(()=>null); alert((j&&j.error)?j.error:'Error'); return;
            }
            const j = await res.json();
            const list = (j.data || []).map(item => {
              const u = item.user || item || {};
              return `<div style="display:flex;align-items:center;gap:8px;padding:8px"><img src="${u.avatar_url||'/imagen/default-avatar.png'}" style="width:32px;height:32px;border-radius:999px;object-fit:cover"/><div>${u.full_name||u.email||u.id}</div></div>`;
            }).join('');
            const modal = document.createElement('div');
            modal.style.position = 'fixed'; modal.style.left='0'; modal.style.top='0'; modal.style.right='0'; modal.style.bottom='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center';
            modal.innerHTML = `<div style="max-width:420px;width:90%;background:var(--bg);color:var(--text);padding:12px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2)"><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'><strong>Siguiendo</strong><button id='closeModal'>Cerrar</button></div><div style='max-height:60vh;overflow:auto'>${list || '<div class="muted">No sigue a nadie</div>'}</div></div>`;
            document.body.appendChild(modal);
            modal.querySelector('#closeModal').addEventListener('click', ()=>modal.remove());
          } catch (e) { console.error(e); alert('Error al obtener la lista de seguidos'); }
        });
      }
    })();
  </script>
  <script>
    (function(){
      // Variables
      const profileUserId = '<%= user.id %>';
      const currentUserId = '<%= typeof currentUserId !== "undefined" ? currentUserId : '' %>';

      const chatDrawer = document.getElementById('chatDrawer');
      const chatBody = document.getElementById('chatBody');
      const chatTitle = document.getElementById('chatTitle');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const chatClose = document.getElementById('chatClose');

      let chatWith = null; // userId we're chatting with
      let pollTimer = null;

      function renderMessages(messages) {
        chatBody.innerHTML = '';
        messages.forEach(m => {
          const me = String(m.sender_id) === String(currentUserId);
          const el = document.createElement('div');
          el.style.display = 'flex';
          el.style.justifyContent = me ? 'flex-end' : 'flex-start';
          el.innerHTML = `<div style="max-width:78%;padding:8px;border-radius:8px;background:${me ? 'linear-gradient(90deg,#0ea5a0,#06b6d4)' : 'rgba(0,0,0,0.06)'};color:${me ? '#fff' : 'var(--text)'}">${escapeHtml(m.content)}<div style="font-size:10px;margin-top:6px;opacity:0.7;text-align:right">${(new Date(m.created_at)).toLocaleString()}</div></div>`;
          chatBody.appendChild(el);
        });
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function escapeHtml(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      async function loadConversation(withId) {
        if (!withId) return;
        try {
          const res = await fetch(`/api/messages/conversation/${withId}`, { method: 'GET', credentials: 'include' });
          if (!res.ok) return;
          const j = await res.json();
          const msgs = j.data || [];
          renderMessages(msgs);
        } catch (e) { console.error('loadConversation', e); }
      }

      async function sendMessage(toId, text) {
        try {
          if (!text || !toId) return;
          const res = await fetch('/api/messages/send', { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ to: toId, content: text }) });
          if (!res.ok) {
            const j = await res.json().catch(()=>null); alert((j&&j.error)?j.error:'Error enviando'); return;
          }
          // update conversation
          await loadConversation(toId);
        } catch (e) { console.error('sendMessage', e); }
      }

      function startPolling(withId) {
        stopPolling();
        pollTimer = setInterval(()=>{ loadConversation(withId); }, 2500);
      }

      function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

      // Open chat with given user
      function openChat(withId, title) {
        if (!currentUserId) { alert('Necesitas iniciar sesión para enviar mensajes'); return; }
        chatWith = withId;
        chatTitle.textContent = title || 'Chat';
        chatDrawer.style.display = 'flex';
        loadConversation(withId);
        startPolling(withId);
      }

      // Close
      chatClose.addEventListener('click', ()=>{ chatDrawer.style.display='none'; stopPolling(); });

      // Send
      chatSend.addEventListener('click', async ()=>{
        const txt = chatInput.value && chatInput.value.trim();
        if (!txt) return;
        await sendMessage(chatWith || profileUserId, txt);
        chatInput.value = '';
      });

      // Message button on profile
      const msgBtn = document.getElementById('msgBtn');
      if (msgBtn) msgBtn.addEventListener('click', ()=>{ openChat(profileUserId, '<%= user.full_name ? String(user.full_name).replace(/'/g, "\\'") : 'Usuario' %>'); });

      // Inbox ahora se muestra en el panel de avatar (index) — se omite aquí
    })();
  </script>
  <script>
    (function(){
      // avatar picker handlers
      const profileAvatar = document.getElementById('profileFullAvatar');
      const picker = document.getElementById('avatarPickerModal');
      const closePicker = document.getElementById('closeAvatarPicker');
      const avatarList = document.getElementById('avatarList');
      const avatarFile = document.getElementById('avatarFile');
      const uploadBtn = document.getElementById('avatarUploadBtn');
      const uploadProgressWrap = document.getElementById('avatarUploadProgress');

      async function loadAvatarOptions() {
        try {
          avatarList.innerHTML = 'Cargando...';
          const res = await fetch('/api/avatars');
          if (!res.ok) throw new Error('No hay avatares');
          const j = await res.json();
          const files = j && j.data ? (j.data || []) : [];
          if (!files || !files.length) { avatarList.innerHTML = '<div class="muted">No hay avatares disponibles</div>'; return; }
          avatarList.innerHTML = '';
          files.forEach(f => {
            const url = '/imagen/avatares/' + f;
            const el = document.createElement('div'); el.style.padding='6px'; el.style.cursor='pointer'; el.style.width='72px'; el.style.height='72px'; el.style.display='flex'; el.style.justifyContent='center'; el.style.alignItems='center'; el.style.borderRadius='8px'; el.style.border='1px solid rgba(0,0,0,0.06)';
            const img = document.createElement('img'); img.src = url; img.style.maxWidth='64px'; img.style.maxHeight='64px'; img.style.borderRadius='50%'; el.appendChild(img);
            el.addEventListener('click', async ()=>{
              try {
                const res2 = await fetch('/auth/profile/avatar', { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ default_avatar: url }) });
                if (!res2.ok) { const jj = await res2.json().catch(()=>null); alert((jj && jj.error) ? jj.error : 'Error actualizando avatar'); return; }
                const j2 = await res2.json();
                profileAvatar.src = j2.avatar || url;
                alert('Avatar actualizado');
                picker.style.display = 'none';
              } catch (e) { console.error('avatar select error', e); alert('Error actualizando avatar'); }
            });
            avatarList.appendChild(el);
          });
        } catch (e) { console.warn('No se pudieron cargar avatares', e); avatarList.innerHTML = '<div class="muted">No se pudieron cargar avatares.</div>'; }
      }

      if (profileAvatar) {
        profileAvatar.style.cursor = 'pointer';
        profileAvatar.addEventListener('click', async (ev)=>{ ev.preventDefault(); try { picker.style.display = 'flex'; await loadAvatarOptions(); } catch(e){} });
      }
      if (closePicker) closePicker.addEventListener('click', ()=>{ picker.style.display = 'none'; });

      if (uploadBtn) {
        uploadBtn.addEventListener('click', async ()=>{
          const f = avatarFile && avatarFile.files && avatarFile.files[0];
          if (!f) { alert('Selecciona un archivo primero'); return; }
          try {
            uploadProgressWrap.style.display = 'block';
            uploadProgressWrap.querySelector('div').style.width = '0%';
            const fd = new FormData(); fd.append('avatar', f);
            const xhr = new XMLHttpRequest(); xhr.open('POST', '/auth/profile/avatar'); xhr.withCredentials = true;
            xhr.upload.onprogress = (ev) => { if (ev.lengthComputable) uploadProgressWrap.querySelector('div').style.width = Math.round((ev.loaded/ev.total)*100) + '%'; };
            xhr.onload = async () => {
              try {
                if (xhr.status >=200 && xhr.status < 300) {
                  const j = JSON.parse(xhr.responseText || '{}') || {};
                  profileAvatar.src = j.avatar || profileAvatar.src;
                  alert('Avatar actualizado'); picker.style.display = 'none';
                } else {
                  const j = JSON.parse(xhr.responseText || '{}') || {};
                  alert((j && j.error) ? j.error : 'Error subiendo avatar');
                }
              } catch (e) { console.error(e); alert('Error procesando respuesta'); }
              uploadProgressWrap.style.display='none';
            };
            xhr.onerror = ()=>{ alert('Error subiendo avatar'); uploadProgressWrap.style.display='none'; };
            xhr.send(fd);
          } catch (err) { console.error('upload avatar error', err); alert('Error subiendo'); uploadProgressWrap.style.display='none'; }
        });
      }
    })();
  </script>
  <script>
    (function(){
      try {
        const color = "<%= initialTheme %>" || '#ffffff';
        function hexToRgb(hex) {
          const h = hex.replace('#','');
          const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
          const bigint = parseInt(full, 16);
          return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
        }
        function luminance(r,g,b) {
          const a = [r,g,b].map(v=>{ v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4); });
          return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
        }
        document.documentElement.style.setProperty('--bg', color);
        const [r,g,b] = hexToRgb(color);
        const L = luminance(r,g,b);
        const contrastWithWhite = (1.05) / (L + 0.05);
        const contrastWithBlack = (L + 0.05) / 0.05;
        const text = contrastWithWhite >= contrastWithBlack ? '#ffffff' : '#0b0f1a';
        document.documentElement.style.setProperty('--text', text);
        if (text === '#ffffff') {
          document.documentElement.style.setProperty('--muted', '#d1d5db');
          document.documentElement.setAttribute('data-theme','dark');
        } else {
          document.documentElement.style.setProperty('--muted', '#6b7280');
          document.documentElement.setAttribute('data-theme','default');
        }
      } catch (e) { /* ignore */ }
    })();
  </script>
  <script>
    (function(){
      const form = document.getElementById('profileUploadForm');
      if (form) {
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(form);
          try {
            // Use XHR for progress events
            const progressWrap = document.createElement('div'); progressWrap.style.marginTop='8px'; progressWrap.style.height='8px'; progressWrap.style.background='rgba(0,0,0,0.06)'; progressWrap.style.borderRadius='8px'; progressWrap.style.overflow='hidden';
            const inner = document.createElement('div'); inner.style.height='100%'; inner.style.width='0%'; inner.style.background='linear-gradient(90deg,#6b46c1,#7c3aed)'; inner.style.transition='width 120ms linear'; progressWrap.appendChild(inner);
            form.appendChild(progressWrap);

            const xhr = new XMLHttpRequest(); xhr.open('POST', '/auth/profile/photos'); xhr.withCredentials = true;
            xhr.upload.onprogress = (ev) => { if (ev.lengthComputable) inner.style.width = Math.round((ev.loaded/ev.total)*100) + '%'; };
            xhr.onload = () => {
              try {
                if (xhr.status >= 200 && xhr.status < 300) {
                  alert('Subido correctamente'); window.location.reload();
                } else {
                  const j = JSON.parse(xhr.responseText || '{}') || {}; alert((j && j.error)?j.error:'Error');
                }
              } catch (e) { alert('Error procesando la respuesta: ' + (e && e.message ? e.message : e)); }
            };
            xhr.onerror = () => { alert('Error subiendo el archivo'); };
            xhr.send(fd);
          } catch (err) { alert('Error subiendo: '+(err.message||err)); }
        });
      }
    })();
  </script>
</body>
</html>
