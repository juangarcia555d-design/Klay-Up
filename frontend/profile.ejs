<!doctype html>
<%
  const initialTheme = (user && user.theme && String(user.theme).trim() !== 'default') ? user.theme : '#ffffff';
%>
<html lang="es" data-theme="<%= initialTheme %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mi Perfil — Klay-Up</title>
  <link rel="stylesheet" href="/styles.css?v=<%= Date.now() %>">
  <link rel="stylesheet" href="/profile.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <main style="max-width:920px;margin:32px auto;padding:16px;">
    <a href="/app" style="display:inline-block;margin-bottom:12px;">← Volver</a>
    <section class="profile-full">
      <div class="profile-hero">
        <img id="profileFullAvatar" src="<%= user.avatar_url || '/imagen/default-avatar.png' %>" alt="Avatar" class="profile-avatar-large" />
        <div class="profile-meta">
          <h1>
            <%= user.full_name || 'Sin nombre' %>
            <% if (user && user.verified_role) { %>
              <% if (String(user.verified_role).toUpperCase() === 'ADMIN') { %>
                <span class="verified-badge admin" title="Administrador verificado">
                  <svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M9.5 16.5L5 12l1.4-1.4L9.5 13.7 17.6 5.6 19 7l-9.5 9.5z"></path></svg>
                </span>
              <% } else if (String(user.verified_role).toUpperCase() === 'ARTIST') { %>
                <span class="verified-badge artist" title="Artista verificado">
                  <svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M12 2C7.03 2 3 6.03 3 11c0 2.95 2.41 5.4 5.36 5.7.66.07 1.2.61 1.3 1.27.16 1.09 1.15 1.93 2.26 1.93 4.97 0 9-4.03 9-9S16.97 2 12 2zm-1 5a1 1 0 11.001 2.001A1 1 0 0111 7zm4 2a1 1 0 11.001 2.001A1 1 0 0115 9z"></path></svg>
                </span>
              <% } %>
            <% } %>
          </h1>
          <div class="muted"><%= user.email %></div>
          <p class="profile-desc"><%= user.profile_description || '' %></p>
          <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
            <div style="font-weight:600;cursor:pointer;" id="followerCount">Seguidores: <span id="profileFollowerNum"><%= typeof followerCount !== 'undefined' ? followerCount : 0 %></span></div>
            <div style="font-weight:600;cursor:pointer;" id="followingCount">Siguiendo: <span id="profileFollowingNum"><%= typeof followingCount !== 'undefined' ? followingCount : 0 %></span></div>
          </div>
          <div class="profile-actions">
            <% if (typeof isOwner !== 'undefined' && isOwner) { %>
              <a class="btn btn-primary" href="/app">Mi panel</a>
            <% } %>
            <% if (!isOwner && viewerAuthenticated) { %>
              <button id="followBtn" class="btn btn-primary"><%= (typeof isFollowing !== 'undefined' && isFollowing) ? 'Siguiendo' : 'Seguir' %></button>
              <button id="msgBtn" class="btn">Mensaje</button>
            <% } %>
            <a class="btn" href="/u/<%= user.id %>">Compartir</a>
          </div>
        </div>
      </div>

      <hr />

      <% if (typeof isOwner !== 'undefined' && isOwner) { %>
      <section class="profile-upload">
        <h3>Subir fotos a tu galería</h3>
        <form id="profileUploadForm" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="Título" />
            <textarea name="description" placeholder="Descripción (máx 100 chars)" maxlength="100"></textarea>
          <!-- Fecha eliminada: se usará la hora de publicación automática -->
          <select name="category">
            <option value="GALERIA">GALERIA</option>
            <option value="FOTOS">FOTOS</option>
            <option value="RECUERDOS">RECUERDOS</option>
          </select>
          <input type="file" name="file" accept="image/*,video/*" multiple required />
          <div style="margin-top:8px;"><button type="submit">Subir a mi galería</button></div>
        </form>
      </section>
      <% } %>

      <section style="margin-top:18px;">
      <% /* Bandeja movida al panel (avatar) - se muestra en el panel de avatar en index */ %>
        <h3>Mis fotos</h3>
        <div id="myPhotos" class="grid">
          <% if (Array.isArray(photos) && photos.length) { %>
            <% photos.forEach(function(it) { %>
              <div class="card" data-photo-id="<%= it.id %>">
                <% if (it.url && (it.url.toLowerCase().endsWith('.mp4') || it.url.toLowerCase().endsWith('.webm') || it.url.toLowerCase().endsWith('.ogg') || it.url.toLowerCase().endsWith('.mov') || it.url.toLowerCase().endsWith('.m4v'))) { %>
                  <video class="card-video" controls style="max-width:100%;border-radius:6px;background:#000"><source src="<%= it.url %>" /></video>
                <% } else { %>
                  <img class="card-img" src="<%= it.url %>" alt="<%= it.title || 'Foto' %>" style="max-width:100%;border-radius:6px;" />
                <% } %>
                <div class="card-body">
                  <h3 class="card-title"><%= it.title || '' %></h3>
                  <p class="card-desc"><%= it.description || '' %></p>
                  <div class="card-actions-profile" style="position:absolute;top:8px;right:8px;">
                    <button class="card-ellipsis" type="button" aria-label="Más acciones">⋯</button>
                    <div class="card-ellipsis-menu hidden" style="min-width:120px;">
                      <button class="menu-item card-edit" type="button">Editar</button>
                      <button class="menu-item card-delete" type="button">Eliminar</button>
                    </div>
                  </div>
                  <p class="card-date"><%= it.date_taken ? ('Fecha: ' + it.date_taken) : (it.created_at ? ('Publicado: ' + new Date(it.created_at).toLocaleString()) : '') %></p>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="muted">No hay fotos en tu galería todavía.</div>
          <% } %>
        </div>
      </section>
    </section>
  </main>

  <!-- Panel chat & inbox (reused from index) -->
  <div id="panelInboxBubbles" class="panel-bubbles" style="display:none;gap:8px;align-items:center;padding:6px"></div>
  <div id="panelChat" class="panel-chat hidden" style="display:none">
    <div class="panel-chat-header"><div id="panelChatTitle">Chat</div><div><button id="panelBackToInbox" class="btn">← Bandeja</button><button id="panelCloseChat" class="btn">Cerrar</button></div></div>
    <div id="panelChatBody" class="panel-chat-body"></div>
    <div class="panel-chat-compose"><input id="panelChatInput" placeholder="Escribe un mensaje..." /><button id="panelChatSend" class="btn btn-primary">Enviar</button></div>
  </div>

  <!-- Avatar picker modal -->
  <div id="avatarPickerModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:100000"> 
    <div style="max-width:680px;width:94%;background:var(--bg);color:var(--text);padding:12px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.25);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Seleccionar avatar</strong>
        <button id="closeAvatarPicker" class="btn">Cerrar</button>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;max-height:48vh;overflow:auto;padding:6px" id="avatarList">Loading avatars...</div>
      <hr style="margin:10px 0" />
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-weight:600">Subir avatar</label>
        <input id="avatarFile" type="file" accept="image/*" />
        <button id="avatarUploadBtn" class="btn btn-primary">Subir</button>
        <div id="avatarUploadProgress" style="flex:1;display:none;margin-left:8px;height:8px;background:rgba(0,0,0,0.06);border-radius:8px;overflow:hidden"><div style="height:100%;width:0%;background:linear-gradient(90deg,#6b46c1,#7c3aed);transition:width 120ms linear"></div></div>
      </div>
    </div>
  </div>

  <script>
    window.SUPABASE_URL = "<%= SUPABASE_URL %>" || '';
    window.SUPABASE_ANON_KEY = "<%= SUPABASE_ANON_KEY %>" || '';
    window.API_BASE = window.location.origin;
  </script>
  <!-- Edit modal for profile photos -->
  <div id="profileEditModal" class="modal hidden">
    <div class="modal-content">
      <h3>Editar publicación</h3>
      <form id="profileEditForm">
        <input type="text" name="title" placeholder="Título" required />
        <textarea name="description" placeholder="Descripción (máx 100 chars)" maxlength="100"></textarea>
        <label>Categoría</label>
        <select name="category">
          <option value="GALERIA">GALERIA</option>
          <option value="FOTOS">FOTOS</option>
          <option value="RECUERDOS">RECUERDOS</option>
        </select>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" id="profileEditCancel" class="btn">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const followBtn = document.getElementById('followBtn');
      // Profile photo actions: edit/delete menu
      function hideAllMenus() {
        document.querySelectorAll('.card-ellipsis-menu').forEach(m => m.classList.add('hidden'));
      }
      document.addEventListener('click', (ev) => {
        // close menus when clicking outside
        if (!ev.target.closest || !ev.target.closest('.card-ellipsis-menu') && !ev.target.closest('.card-ellipsis')) {
          hideAllMenus();
        }
      });

      document.querySelectorAll('.card').forEach(card => {
        const btn = card.querySelector('.card-ellipsis');
        const menu = card.querySelector('.card-ellipsis-menu');
        const editBtn = card.querySelector('.card-edit');
        const delBtn = card.querySelector('.card-delete');
        if (btn && menu) {
          // ensure card is position:relative so menu position absolute anchors correctly
          card.style.position = card.style.position || 'relative';
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            // toggle menu visibility
            const isHidden = menu.classList.contains('hidden');
            hideAllMenus();
            if (isHidden) menu.classList.remove('hidden'); else menu.classList.add('hidden');
          });
        }
        if (editBtn) {
          editBtn.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            const pid = card.dataset.photoId;
            // populate modal with current values
            const title = card.querySelector('.card-title') ? card.querySelector('.card-title').textContent.trim() : '';
            const desc = card.querySelector('.card-desc') ? card.querySelector('.card-desc').textContent.trim() : '';
            const modal = document.getElementById('profileEditModal');
            const form = document.getElementById('profileEditForm');
            if (form) {
              form.elements['title'].value = title;
              form.elements['description'].value = desc;
              // category may not be rendered in card; default to GALERIA
              try { form.elements['category'].value = card.querySelector('.card-cat') ? (card.querySelector('.card-cat').textContent.replace('Categoría:','').trim() || 'GALERIA') : 'GALERIA'; } catch(e){}
              form.dataset.editingId = pid;
            }
            hideAllMenus();
            if (modal) modal.classList.remove('hidden');
          });
        }
        if (delBtn) {
          delBtn.addEventListener('click', async (e) => {
            e.preventDefault(); e.stopPropagation();
            if (!confirm('¿Eliminar esta foto?')) return;
            const pid = card.dataset.photoId;
            try {
              const res = await fetch(`${window.API_BASE}/api/photos/${pid}`, { method: 'DELETE', credentials: 'include' });
              if (!res.ok) throw new Error('Error eliminando');
              // remove card from DOM
              card.parentNode && card.parentNode.removeChild(card);
            } catch (err) { alert('No se pudo eliminar: ' + err.message); }
          });
        }
      });

      // Edit form submit
      const profileEditForm = document.getElementById('profileEditForm');
      if (profileEditForm) {
        profileEditForm.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          const id = profileEditForm.dataset.editingId;
          if (!id) return;
          const payload = {
            title: profileEditForm.elements['title'].value || '',
            description: profileEditForm.elements['description'].value || '',
            category: profileEditForm.elements['category'].value || 'GALERIA'
          };
          try {
            const res = await fetch(`${window.API_BASE}/api/photos/${id}`, { method: 'PUT', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload), credentials: 'include' });
            if (!res.ok) throw new Error('Error al guardar');
            const updated = await res.json();
            // update card DOM
            const card = document.querySelector(`.card[data-photo-id='${id}']`);
            if (card) {
              const t = card.querySelector('.card-title'); if (t) t.textContent = updated.title || payload.title || '';
              const d = card.querySelector('.card-desc'); if (d) d.textContent = updated.description || payload.description || '';
              const c = card.querySelector('.card-cat'); if (c) c.textContent = updated.category ? ('Categoría: ' + updated.category) : '';
            }
            document.getElementById('profileEditModal').classList.add('hidden');
          } catch (err) { alert('No se pudo guardar: ' + err.message); }
        });
      }
      const profileEditCancel = document.getElementById('profileEditCancel');
      if (profileEditCancel) profileEditCancel.addEventListener('click', () => document.getElementById('profileEditModal').classList.add('hidden'));
      function getProfileUserId(){ try { if (typeof window !== 'undefined' && window.profilePageUserId) return String(window.profilePageUserId); const el = document.getElementById('profileData'); return el ? el.dataset.userid : ''; } catch(e){ return ''; } }
      if (followBtn) {
        followBtn.addEventListener('click', async () => {
          try {
            const current = followBtn.textContent.trim();
            let action = 'follow';
            if (current === 'Siguiendo' || current.toLowerCase() === 'siguiendo') action = 'unfollow';

            const endpoint = `/api/users/${getProfileUserId()}/${action}`;
            const res = await fetch(endpoint, { method: 'POST', credentials: 'include' });
            if (!res.ok) {
              const j = await res.json().catch(()=>null);
              alert((j && j.error) ? j.error : 'Error');
              return;
            }

            const data = await res.json();
            // actualizar contadores si vienen
            if (typeof data.followerCount !== 'undefined') document.getElementById('profileFollowerNum').textContent = data.followerCount || 0;
            if (typeof data.followingCount !== 'undefined') document.getElementById('profileFollowingNum').textContent = data.followingCount || 0;

            // actualizar etiqueta
            if (action === 'follow') followBtn.textContent = 'Siguiendo';
            else followBtn.textContent = 'Seguir';
          } catch (e) { console.error(e); alert('Error al realizar la acción'); }
        });
      }

      const followerCountEl = document.getElementById('followerCount');
      // Helper: escape HTML and show a single modal (will remove any existing one to avoid stacking)
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c] || c)); }
      // Helper to show a single modal (will remove any existing one to avoid stacking)
      function showListModal(titleText, innerHtml) {
        try {
          const existing = document.getElementById('profileListModal');
          if (existing) existing.remove();
        } catch(e){}
        try {
          const modal = document.createElement('div');
          modal.id = 'profileListModal';
          modal.style.position = 'fixed'; modal.style.left='0'; modal.style.top='0'; modal.style.right='0'; modal.style.bottom='0'; modal.style.background='rgba(0,0,0,0.4)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='100000';
          modal.innerHTML = `<div style="max-width:420px;width:90%;background:var(--bg);color:var(--text);padding:12px;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2)"><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px'><strong>${escapeHtml(titleText||'Lista')}</strong><button id='closeProfileListModal'>Cerrar</button></div><div style='max-height:60vh;overflow:auto'>${innerHtml || '<div class="muted">Sin resultados</div>'}</div></div>`;
          document.body.appendChild(modal);
          const btn = modal.querySelector('#closeProfileListModal'); if (btn) btn.addEventListener('click', ()=>modal.remove());
          try { window.showListModal = showListModal; } catch(e){}
        } catch(e){ console.error('showListModal error', e); }
      }

      if (followerCountEl) {
        followerCountEl.addEventListener('click', async () => {
          try {
            const profileUserIdLocal = getProfileUserId();
            console.debug('[diag] fetching followers for profileUserId ->', profileUserIdLocal);
            const res = await fetch(`/api/users/${profileUserIdLocal}/followers`);
            console.debug('[diag] followers response status ->', res && res.status);
            if (!res.ok) { const j = await res.json().catch(()=>null); console.debug('[diag] followers error json ->', j); alert((j&&j.error)?j.error:'Error'); return; }
            const j = await res.json();
            console.debug('[diag] followers payload ->', j);
            const listArr = (j.data || []);
            console.debug('[diag] followers count payload length ->', listArr.length, 'apiCount:', j.count);
            const list = listArr.map(item => {
              const u = item.user || item || {};
              const badgeHtml = u.verified_role ? (String(u.verified_role).toUpperCase() === 'ADMIN' ? '<span class="verified-badge admin" title="Administrador verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M9.5 16.5L5 12l1.4-1.4L9.5 13.7 17.6 5.6 19 7l-9.5 9.5z"></path></svg></span>' : '<span class="verified-badge artist" title="Artista verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M12 2C7.03 2 3 6.03 3 11c0 2.95 2.41 5.4 5.36 5.7.66.07 1.2.61 1.3 1.27.16 1.09 1.15 1.93 2.26 1.93 4.97 0 9-4.03 9-9S16.97 2 12 2zm-1 5a1 1 0 11.001 2.001A1 1 0 0111 7zm4 2a1 1 0 11.001 2.001A1 1 0 0115 9z"></path></svg></span>') : '';
              return `<div style="display:flex;align-items:center;gap:8px;padding:8px"><img src="${u.avatar_url||'/imagen/default-avatar.png'}" style="width:32px;height:32px;border-radius:999px;object-fit:cover"/><div><a href='/u/${u.id}' style='text-decoration:none;color:inherit'>${escapeHtml(u.full_name||u.email||u.id)}</a>${badgeHtml}</div></div>`;
            }).join('');
            showListModal('Seguidores', list || '<div class="muted">No tiene seguidores</div>');
          } catch (e) { console.error(e); alert('Error al obtener seguidores'); }
        });
      }

      const followingCountEl = document.getElementById('followingCount');
      if (followingCountEl) {
        followingCountEl.addEventListener('click', async () => {
          try {
            const profileUserIdLocal = getProfileUserId();
            console.debug('[diag] fetching following for profileUserId ->', profileUserIdLocal);
            const res = await fetch(`/api/users/${profileUserIdLocal}/following`);
            console.debug('[diag] following response status ->', res && res.status);
            if (!res.ok) { const j = await res.json().catch(()=>null); console.debug('[diag] following error json ->', j); alert((j&&j.error)?j.error:'Error'); return; }
            const j = await res.json();
            console.debug('[diag] following payload ->', j);
            const listArr = (j.data || []);
            console.debug('[diag] following payload length ->', listArr.length, 'apiCount:', j.count);
            const list = listArr.map(item => {
              const u = item.user || item || {};
              const badgeHtml = u.verified_role ? (String(u.verified_role).toUpperCase() === 'ADMIN' ? '<span class="verified-badge admin" title="Administrador verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M9.5 16.5L5 12l1.4-1.4L9.5 13.7 17.6 5.6 19 7l-9.5 9.5z"></path></svg></span>' : '<span class="verified-badge artist" title="Artista verificado"><svg viewBox="0 0 24 24" width="12" height="12" aria-hidden="true"><path class="icon" d="M12 2C7.03 2 3 6.03 3 11c0 2.95 2.41 5.4 5.36 5.7.66.07 1.2.61 1.3 1.27.16 1.09 1.15 1.93 2.26 1.93 4.97 0 9-4.03 9-9S16.97 2 12 2zm-1 5a1 1 0 11.001 2.001A1 1 0 0111 7zm4 2a1 1 0 11.001 2.001A1 1 0 0115 9z"></path></svg></span>') : '';
              return `<div style="display:flex;align-items:center;gap:8px;padding:8px"><img src="${u.avatar_url||'/imagen/default-avatar.png'}" style="width:32px;height:32px;border-radius:999px;object-fit:cover"/><div><a href='/u/${u.id}' style='text-decoration:none;color:inherit'>${escapeHtml(u.full_name||u.email||u.id)}</a>${badgeHtml}</div></div>`;
            }).join('');
            showListModal('Siguiendo', list || '<div class="muted">No sigue a nadie</div>');
          } catch (e) { console.error(e); alert('Error al obtener la lista de seguidos'); }
        });
      }
    })();
  </script>

  
  <script>
    (function(){
      // avatar picker handlers
      const profileAvatar = document.getElementById('profileFullAvatar');
      const picker = document.getElementById('avatarPickerModal');
      const closePicker = document.getElementById('closeAvatarPicker');
      const avatarList = document.getElementById('avatarList');
      const avatarFile = document.getElementById('avatarFile');
      const uploadBtn = document.getElementById('avatarUploadBtn');
      const uploadProgressWrap = document.getElementById('avatarUploadProgress');
      // Detectar si el perfil es propio (isOwner viene del backend)
      const isOwner = <%- typeof isOwner !== 'undefined' && isOwner ? 'true' : 'false' %>;

      async function loadAvatarOptions() {
        try {
          avatarList.innerHTML = 'Cargando...';
          const res = await fetch('/api/avatars');
          if (!res.ok) throw new Error('No hay avatares');
          const j = await res.json();
          const files = j && j.data ? (j.data || []) : [];
          if (!files || !files.length) { avatarList.innerHTML = '<div class="muted">No hay avatares disponibles</div>'; return; }
          avatarList.innerHTML = '';
          files.forEach(f => {
            const url = '/imagen/avatares/' + f;
            const el = document.createElement('div'); el.style.padding='6px'; el.style.cursor='pointer'; el.style.width='72px'; el.style.height='72px'; el.style.display='flex'; el.style.justifyContent='center'; el.style.alignItems='center'; el.style.borderRadius='8px'; el.style.border='1px solid rgba(0,0,0,0.06)';
            const img = document.createElement('img'); img.src = url; img.style.maxWidth='64px'; img.style.maxHeight='64px'; img.style.borderRadius='50%'; el.appendChild(img);
            el.addEventListener('click', async ()=>{
              try {
                const res2 = await fetch('/auth/profile/avatar', { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ default_avatar: url }) });
                if (!res2.ok) { const jj = await res2.json().catch(()=>null); alert((jj && jj.error) ? jj.error : 'Error actualizando avatar'); return; }
                const j2 = await res2.json();
                profileAvatar.src = j2.avatar || url;
                alert('Avatar actualizado');
                picker.style.display = 'none';
              } catch (e) { console.error('avatar select error', e); alert('Error actualizando avatar'); }
            });
            avatarList.appendChild(el);
          });
        } catch (e) { console.warn('No se pudieron cargar avatares', e); avatarList.innerHTML = '<div class="muted">No se pudieron cargar avatares.</div>'; }
      }

      if (profileAvatar) {
        if (isOwner) {
          profileAvatar.style.cursor = 'pointer';
          profileAvatar.addEventListener('click', async (ev)=>{ ev.preventDefault(); try { picker.style.display = 'flex'; await loadAvatarOptions(); } catch(e){} });
        } else {
          profileAvatar.style.cursor = 'default';
          profileAvatar.addEventListener('click', (ev)=>{ ev.preventDefault(); /* Solo vista, sin acción */ });
        }
      }
      if (closePicker) closePicker.addEventListener('click', ()=>{ picker.style.display = 'none'; });

      if (uploadBtn) {
        uploadBtn.addEventListener('click', async ()=>{
          const f = avatarFile && avatarFile.files && avatarFile.files[0];
          if (!f) { alert('Selecciona un archivo primero'); return; }
          try {
            uploadProgressWrap.style.display = 'block';
            uploadProgressWrap.querySelector('div').style.width = '0%';
            const fd = new FormData(); fd.append('avatar', f);
            const xhr = new XMLHttpRequest(); xhr.open('POST', '/auth/profile/avatar'); xhr.withCredentials = true;
            xhr.upload.onprogress = (ev) => { if (ev.lengthComputable) uploadProgressWrap.querySelector('div').style.width = Math.round((ev.loaded/ev.total)*100) + '%'; };
            xhr.onload = async () => {
              try {
                if (xhr.status >=200 && xhr.status < 300) {
                  const j = JSON.parse(xhr.responseText || '{}') || {};
                  profileAvatar.src = j.avatar || profileAvatar.src;
                  alert('Avatar actualizado'); picker.style.display = 'none';
                } else {
                  const j = JSON.parse(xhr.responseText || '{}') || {};
                  alert((j && j.error) ? j.error : 'Error subiendo avatar');
                }
              } catch (e) { console.error(e); alert('Error procesando respuesta'); }
              uploadProgressWrap.style.display='none';
            };
            xhr.onerror = ()=>{ alert('Error subiendo avatar'); uploadProgressWrap.style.display='none'; };
            xhr.send(fd);
          } catch (err) { console.error('upload avatar error', err); alert('Error subiendo'); uploadProgressWrap.style.display='none'; }
        });
      }
    })();
  </script>
  <script>
    (function(){
      try {
        const color = "<%= initialTheme %>" || '#ffffff';
        function hexToRgb(hex) {
          const h = hex.replace('#','');
          const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
          const bigint = parseInt(full, 16);
          return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
        }
        function luminance(r,g,b) {
          const a = [r,g,b].map(v=>{ v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4); });
          return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
        }
        document.documentElement.style.setProperty('--bg', color);
        const [r,g,b] = hexToRgb(color);
        const L = luminance(r,g,b);
        const contrastWithWhite = (1.05) / (L + 0.05);
        const contrastWithBlack = (L + 0.05) / 0.05;
        const text = contrastWithWhite >= contrastWithBlack ? '#ffffff' : '#0b0f1a';
        document.documentElement.style.setProperty('--text', text);
        if (text === '#ffffff') {
          document.documentElement.style.setProperty('--muted', '#d1d5db');
          document.documentElement.setAttribute('data-theme','dark');
        } else {
          document.documentElement.style.setProperty('--muted', '#6b7280');
          document.documentElement.setAttribute('data-theme','default');
        }
      } catch (e) { /* ignore */ }
    })();
  </script>
  <script>
    (function(){
      const form = document.getElementById('profileUploadForm');
      if (form) {
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(form);
          try {
            // Use XHR for progress events
            const progressWrap = document.createElement('div'); progressWrap.style.marginTop='8px'; progressWrap.style.height='8px'; progressWrap.style.background='rgba(0,0,0,0.06)'; progressWrap.style.borderRadius='8px'; progressWrap.style.overflow='hidden';
            const inner = document.createElement('div'); inner.style.height='100%'; inner.style.width='0%'; inner.style.background='linear-gradient(90deg,#6b46c1,#7c3aed)'; inner.style.transition='width 120ms linear'; progressWrap.appendChild(inner);
            form.appendChild(progressWrap);

            const xhr = new XMLHttpRequest(); xhr.open('POST', '/auth/profile/photos'); xhr.withCredentials = true;
            xhr.upload.onprogress = (ev) => { if (ev.lengthComputable) inner.style.width = Math.round((ev.loaded/ev.total)*100) + '%'; };
            xhr.onload = () => {
              try {
                if (xhr.status >= 200 && xhr.status < 300) {
                  alert('Subido correctamente'); window.location.reload();
                } else {
                  const j = JSON.parse(xhr.responseText || '{}') || {}; alert((j && j.error)?j.error:'Error');
                }
              } catch (e) { alert('Error procesando la respuesta: ' + (e && e.message ? e.message : e)); }
            };
            xhr.onerror = () => { alert('Error subiendo el archivo'); };
            xhr.send(fd);
          } catch (err) { alert('Error subiendo: '+(err.message||err)); }
        });
      }
    })();
    </script>
  <!-- Global chat drawer (copiado de index) -->
  <div id="chatDrawer" style="position:fixed;right:16px;bottom:16px;width:360px;max-width:calc(100% - 32px);background:var(--bg);color:var(--text);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:none;flex-direction:column;overflow:hidden;z-index:9999">
    <div style="padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between">
      <div id="chatTitle" style="font-weight:700">Chat</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatClose" class="btn">Cerrar</button>
      </div>
    </div>
    <div id="chatBody" style="padding:8px;max-height:320px;overflow:auto;background:transparent;display:flex;flex-direction:column;gap:8px"></div>
    <div style="padding:8px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:8px;align-items:center">
      <input id="chatInput" placeholder="Escribe un mensaje..." style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:inherit" />
      <button id="chatSend" class="btn btn-primary">Enviar</button>
    </div>
  </div>
  <script>
    // Exponer id del perfil que se está viendo PARA que app.js lo lea al inicializarse
    try { window.profilePageUserId = '<%= user.id %>'; } catch(e){}
  </script>
  <div id="profileData" style="display:none"
       data-userid="<%= user.id %>"
       data-fullname="<%= (user && user.full_name) ? (''+user.full_name).replace(/"/g,'&quot;') : 'Usuario' %>"></div>
  <script src="/app.js?v=<%= Date.now() %>"></script>
  <script>
    (function(){
      try {
        console.log('[diag] profile: DOM ready - checking chat functions...');
        console.log('[diag] typeof openGlobalChat ->', typeof window.openGlobalChat);
        console.log('[diag] typeof openPanelChat ->', typeof window.openPanelChat);
        console.log('[diag] __openPanelChatRequests ->', window.__openPanelChatRequests);
        Array.from(document.scripts || []).forEach(s=>{ try{ if (s.src) console.log('[diag] script loaded ->', s.src); } catch(e){} });
        window.addEventListener('error', function(ev){ try{ console.error('[diag] window error ->', ev.message, ev.filename, ev.lineno, ev.error); }catch(e){} });
        window.addEventListener('unhandledrejection', function(ev){ try{ console.error('[diag] unhandledrejection ->', ev.reason); }catch(e){} });
      } catch (e) { console.error('[diag] init failure', e); }
    })();
  </script>
  <script>
    // Attach message button handler after app.js is loaded so window.openPanelChat/event listener exists
    (function(){
      const profileDataEl = document.getElementById('profileData');
      const profileUserId = profileDataEl ? profileDataEl.dataset.userid : '';
      const title = profileDataEl ? profileDataEl.dataset.fullname || 'Usuario' : 'Usuario';
      // attach immediately (script loaded at end of body so DOM elements exist)
      try {
        const msgBtn = document.getElementById('msgBtn');
        if (!msgBtn) return;
        msgBtn.addEventListener('click', async ()=>{
          try { console.debug('profile: mensaje click'); } catch(e){}
          console.log('profile: message click -> request openPanelChat', {id: profileUserId, title});
          // Intento primario: abrir el drawer global (comportamiento anterior). fallback a panel si no existe
          try {
            if (typeof window.openGlobalChat === 'function') { window.openGlobalChat(profileUserId, title); return; }
          } catch (e) { console.warn('direct openGlobalChat call failed', e); }
          try {
            if (typeof window.openPanelChat === 'function') { window.openPanelChat(profileUserId, title); return; }
          } catch (e) { console.warn('direct openPanelChat call failed', e); }

          // Fallback: si no existe openPanelChat, intentar abrir manualmente el panel que insertamos
          try {
            const panelInboxEl = document.getElementById('panelInboxBubbles');
            const panelChatEl = document.getElementById('panelChat');
            const panelTitle = document.getElementById('panelChatTitle');
            const panelBody = document.getElementById('panelChatBody');
            const input = document.getElementById('panelChatInput');
            const sendBtn = document.getElementById('panelChatSend');
            if (panelInboxEl) panelInboxEl.style.display = 'none';
            if (panelChatEl) {
              panelChatEl.classList.remove('hidden');
              panelChatEl.style.visibility = 'visible';
              panelChatEl.style.display = 'block';
            }
            if (panelTitle) panelTitle.textContent = title || 'Chat';

            // render simple messages helper
            function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c)); }
            function renderMessages(messages){ if (!panelBody) return; panelBody.innerHTML = ''; messages.forEach(m=>{ const me = String(m.sender_id) === String(window.currentUserId||''); const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent = me ? 'flex-end' : 'flex-start'; el.innerHTML = `<div style="max-width:80%;padding:8px;border-radius:8px;background:${me ? 'linear-gradient(90deg,#0ea5a0,#06b6d4)' : 'rgba(0,0,0,0.06)'};color:${me ? '#fff':'var(--text)'}">${(m.content?escapeHtml(m.content):'')}<div style="font-size:10px;margin-top:6px;opacity:0.7;text-align:right">${(m.created_at? (new Date(m.created_at)).toLocaleString(): '')}</div></div>`; panelBody.appendChild(el); }); panelBody.scrollTop = panelBody.scrollHeight; }

            // load conversation once
            try {
              const res = await fetch(`${window.API_BASE || ''}/api/messages/conversation/${profileUserId}`, { credentials: 'include' });
              if (res && res.ok) {
                const j = await res.json().catch(()=>({}));
                const msgs = (j && j.data) ? j.data : [];
                renderMessages(msgs);
              } else {
                if (panelBody) panelBody.innerHTML = '<div class="muted">No se pudo cargar la conversación</div>';
              }
            } catch (e) { console.error('fallback load conversation', e); }

            // wire send button in fallback
            if (sendBtn) {
              sendBtn.onclick = async () => {
                const text = input && input.value && input.value.trim(); if (!text) return;
                try {
                  const r = await fetch(`${window.API_BASE || ''}/api/messages/send`, { method: 'POST', credentials: 'include', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ to: profileUserId, content: text }) });
                  if (!r.ok) { const jj = await r.json().catch(()=>null); alert((jj && jj.error) ? jj.error : 'Error enviando'); return; }
                  if (input) input.value = '';
                  // reload conversation
                  try { const nr = await fetch(`${window.API_BASE || ''}/api/messages/conversation/${profileUserId}`, { credentials: 'include' }); if (nr && nr.ok) { const nj = await nr.json().catch(()=>null); if (nj && nj.data) renderMessages(nj.data); } } catch(e){}
                } catch(e){ console.error('fallback send error', e); }
              };
            }
            return;
          } catch (e) { console.error('fallback opening panel failed', e); }

          // último recurso: notificar al usuario
          try { alert('No fue posible abrir el chat. Revisa la consola.'); } catch(e){}
        });
      } catch (e) { console.error('attach msgBtn handler error', e); }
    })();
  </script>
</body>
</html>
